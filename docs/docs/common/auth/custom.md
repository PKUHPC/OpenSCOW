---
sidebar_position: 4
title: 自定义
---

# 自定义认证

如果系统提供的认证系统不能满足您的需求，您可以自己使用和实现一个自定义认证服务。

## 使用自定义认证服务

您自己编写的自定义认证服务应该被打包为一个docker镜像，放在您部署所在机器可以访问的地址上。

修改scow-deployment的config.py的`AUTH`部分以使用您的自定义认证服务。

```python title="config.py"
#
# ------ 自定义认证系统 -------
# 如果使用自带认证系统，请不要修改此配置
# 默认使用自带认证系统
#
AUTH = {
  # 镜像地址。必填，只要是能访问的镜像地址即可。
  "IMAGE": "ghcr.io/pkuhpc/scow-auth:master",
 
  # 端口映射（可选）
  # "PORTS": ["80:80", "3302:3302"],
 
  # 环境变量（可选）
  # "ENV": {
  #   "KEY": "123"
  # },
 
  # 卷映射（可选）
  # 默认添加/etc/hosts:/etc/hosts和./config:/etc/scow
  # 可选添加其他映射
  # "VOLUMES": {
  #   "./test.py": "/etc/test.py"  ,
  # }
}
```

## 实现一个自定义认证服务

一个认证服务本质是一个实现了以下HTTP API的HTTP服务器。

请注意

- 以`/public`开头的API将会是用户可以直接访问的，其他的用户不可直接访问
- 所有响应和处于`body`位置的参数均为json格式

### GET /public/auth

发起登录。

#### 请求

| 参数          | 位置        | 类型   | 是否必须 | 解释                                                         |
| ------------- | ----------- | ------ | -------- | ------------------------------------------------------------ |
| `callbackUrl` | querystring | 字符串 | 否       | 登录完成后的回调地址。如果没有，需回调到`/api/auth/callback` |

#### 响应

返回登录HTML或者重定向到实际的登录界面。

#### 解释

此API用于进行实际的登录操作。用户点击登录后，系统将会重定向到这个URL。您可以选择自己实现一个登录页面，或者重定向到第三方登录认证的页面。

登录完成后，请返回一个302的请求到`callbackUrl`指定的地址，并附上querystring`?token={您用来跟踪本用户的状态的token}`。这些token的生成和保存您需要自己实现。后续的用户将会带着此token用于鉴权。

如果您在后端使用类似OAuth2的认证系统，这些认证系统登录完成后会给一个token用于跟踪用户状态并重定向到您指定的回调地址。对于这些系统，您应该自己实现一个单独的回调地址（且这些回调地址的URL必须以`/public`为前缀以使用户可以直接访问），在这些地址的处理函数中获取认证系统给予的token，并使用token进行后续的处理（例如生成自己的token，将这些token映射到用户等）。处理完成后，再回调到`callbackUrl`指定的地址。

### GET /validateToken

验证token，返回对应的用户ID。

#### 请求

| 参数    | 位置        | 类型   | 是否必须 | 解释        |
| ------- | ----------- | ------ | -------- | ----------- |
| `token` | querystring | 字符串 | 是       | 用户的token |

#### 响应

##### 200 OK

| 字段         | 类型   | 是否必须 | 解释                      |
| ------------ | ------ | -------- | ------------------------- |
| `identityId` | 字符串 | 是       | 此token对应的用户的用户ID |

##### 400

| 字段   | 类型                      | 是否必须 | 解释                       |
| ------ | ------------------------- | -------- | -------------------------- |
| `code` | 字符串常量`INVALID_TOKEN` | 是       | `INVALID_TOKEN`：token无效 |

#### 解释

用户登录后，所有操作之前将会使用此token进行鉴权。系统首先使用用户的token通过这个API查询用户的身份，然后进行后续的操作。这里的token即是在`GET /public/auth`完成后，系统生成的用户token。

### GET /capabilities

返回认证系统支持的能力。

#### 请求

无。

#### 响应

##### 200 OK

| 字段             | 类型    | 是否必须 | 解释                                 |
| ---------------- | ------- | -------- | ------------------------------------ |
| `createUser`     | boolean | 是       | 此认证系统是否支持创建用户           |
| `changePassword` | boolean | 是       | 此认证系统是否支持修改用户密码       |
| `validateName`   | boolean | 是       | 此认证系统是否支持验证用户名和其姓名 |

#### 解释

此API用于认证系统声明自己的支持的能力。系统的其他部分将会根据此API的返回值选择性地选择是否显示某些功能。例如，如果`changePassword`为false，那么前端系统将会不显示修改密码的功能。

### PATCH /password

修改密码

#### 请求

| 参数          | 位置 | 类型   | 是否必须 | 解释   |
| ------------- | ---- | ------ | -------- | ------ |
| `identityId`  | body | 字符串 | 是       | 用户ID |
| `oldPassword` | body | 字符串 | 是       | 原密码 |
| `newPassword` | body | 字符串 | 是       | 新密码 |

#### 响应

| 状态码 | 内容 | 解释               |
| ------ | ---- | ------------------ |
| `204`  | 无   | 修改完成           |
| `404`  | 无   | 用户未找到         |
| `412`  | 无   | 原密码不正确       |
| `501`  | 无   | 不支持修改密码功能 |

#### 解释

此API用于完成修改密码的功能。

### POST /user

创建用户。

#### 请求

| 参数         | 位置 | 类型   | 是否必须 | 解释               |
| ------------ | ---- | ------ | -------- | ------------------ |
| `identityId` | body | 字符串 | 是       | 用户ID             |
| `password`   | body | 字符串 | 是       | 密码               |
| `id`         | body | 整数   | 是       | 用户在数据库中的ID |
| `name`       | body | 字符串 | 是       | 用户姓名           |
| `mail`       | body | 字符串 | 是       | 用户邮箱           |

#### 响应

| 状态码 | 内容 | 解释               |
| ------ | ---- | ------------------ |
| `204`  | 无   | 创建完成           |
| `409`  | 无   | 用户ID已经存在     |
| `501`  | 无   | 不支持创建用户功能 |

#### 解释 

此API用于在认证系统中创建用户。当前，系统只支持通过管理系统创建用户。管理系统首先在自己的数据库中创建用户，然后请求认证系统创建用户。请求参数中的`id`即是数据库中这个新的用户的自增ID。如果认证系统返回非成功的返回值，管理系统将会撤回在数据库中的项。

### DELETE /token

无效化一个token。

#### 请求

| 参数    | 位置  | 类型   | 是否必须 | 解释  |
| ------- | ----- | ------ | -------- | ----- |
| `token` | query | 字符串 | 是       | token |

#### 响应

| 状态码 | 内容 | 解释                                            |
| ------ | ---- | ----------------------------------------------- |
| `204`  | 无   | 操作完成。如果token不存在也应该返回这个状态码。 |

#### 解释 

此API用于无效化一个token。调用这个请求后，这个token将不应该继续能够通过`GET /validateToken`获得用户的信息。

### GET /validateName

验证用户姓名和用户ID是否匹配。

#### 请求

| 参数         | 位置  | 类型   | 是否必须 | 解释     |
| ------------ | ----- | ------ | -------- | -------- |
| `identityId` | query | 字符串 | 是       | 用户ID   |
| `name`       | query | 字符串 | 是       | 用户姓名 |

#### 响应

| 状态码 | 内容                      | 解释               |
| ------ | ------------------------- | ------------------ |
| `200`  | JSON`{ result: boolean }` | 返回是否匹配。     |
| `404`  | 无                        | 用户ID不存在       |
| `501`  | 无                        | 不支持验证用户姓名 |

#### 解释

此API用于验证在底层的认证系统中，一个用户的ID以及姓名是否匹配。
