"use strict";(self.webpackChunk_scow_docs=self.webpackChunk_scow_docs||[]).push([[1501],{74789:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>d});var r=t(49214),a=t(5409);const l={sidebar_position:10,title:"\u90e8\u7f72\u96c6\u7fa4\u76d1\u63a7"},s="\u90e8\u7f72\u96c6\u7fa4\u76d1\u63a7",o={id:"hpccluster/cluster-monitor/index",title:"\u90e8\u7f72\u96c6\u7fa4\u76d1\u63a7",description:"\u914d\u7f6e\u8be5\u529f\u80fd\u53ef\u4ee5\u8ba9\u7ba1\u7406\u5458\u5728\u7ba1\u7406\u7cfb\u7edf\u4e2d\u67e5\u770b\u96c6\u7fa4\u8d44\u6e90\u4fe1\u606f\u548c\u544a\u8b66\u65e5\u5fd7\uff0c\u9700\u8981\u914d\u7f6e Prometheus\u3001Grafana\u3001Alertmanager\u3001alertsnitch\u3001MySQL \u5b89\u88c5",source:"@site/docs/hpccluster/cluster-monitor/index.md",sourceDirName:"hpccluster/cluster-monitor",slug:"/hpccluster/cluster-monitor/",permalink:"/OpenSCOW/pr-preview/pr-1478/docs/hpccluster/cluster-monitor/",draft:!1,unlisted:!1,editUrl:"https://github.com/PKUHPC/OpenSCOW/edit/main/website/docs/hpccluster/cluster-monitor/index.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10,title:"\u90e8\u7f72\u96c6\u7fa4\u76d1\u63a7"},sidebar:"hpccluster",previous:{title:"intel\u7f16\u8bd1\u5668\u5b89\u88c5",permalink:"/OpenSCOW/pr-preview/pr-1478/docs/hpccluster/intel"}},i={},d=[{value:"\u4e00\u3001\u73af\u5883\u51c6\u5907",id:"\u4e00\u73af\u5883\u51c6\u5907",level:2},{value:"\u4e8c\u3001\u521b\u5efa\u914d\u7f6e\u6587\u4ef6",id:"\u4e8c\u521b\u5efa\u914d\u7f6e\u6587\u4ef6",level:2},{value:"\u914d\u7f6e Grafana",id:"\u914d\u7f6e-grafana",level:3},{value:"\u7f16\u8f91 grafana \u914d\u7f6e\u6587\u4ef6\uff1a<code>/root/monitor/grafana/grafana.ini</code>",id:"\u7f16\u8f91-grafana-\u914d\u7f6e\u6587\u4ef6rootmonitorgrafanagrafanaini",level:4},{value:"\u7f16\u8f91 grafana \u9ed8\u8ba4\u6570\u636e\u6e90",id:"\u7f16\u8f91-grafana-\u9ed8\u8ba4\u6570\u636e\u6e90",level:4},{value:"\u7f16\u8f91 grafana Mysql \u6570\u636e\u6e90",id:"\u7f16\u8f91-grafana-mysql-\u6570\u636e\u6e90",level:4},{value:"\u7f16\u8f91 grafana \u9762\u677f\u914d\u7f6e",id:"\u7f16\u8f91-grafana-\u9762\u677f\u914d\u7f6e",level:4},{value:"\u7f16\u8f91 grafana \u9762\u677f\u6a21\u677f\u6587\u4ef6",id:"\u7f16\u8f91-grafana-\u9762\u677f\u6a21\u677f\u6587\u4ef6",level:4},{value:"\u914d\u7f6e Prometheus",id:"\u914d\u7f6e-prometheus",level:3},{value:"\u914d\u7f6e Prometheus \u914d\u7f6e\u6587\u4ef6",id:"\u914d\u7f6e-prometheus-\u914d\u7f6e\u6587\u4ef6",level:4},{value:"\u914d\u7f6e Prometheus \u544a\u8b66\u89c4\u5219",id:"\u914d\u7f6e-prometheus-\u544a\u8b66\u89c4\u5219",level:4},{value:"\u914d\u7f6e Alertmanager",id:"\u914d\u7f6e-alertmanager",level:3},{value:"\u914d\u7f6e Alertmanager \u914d\u7f6e\u6587\u4ef6",id:"\u914d\u7f6e-alertmanager-\u914d\u7f6e\u6587\u4ef6",level:4},{value:"\u914d\u7f6e Alertmanager \u544a\u8b66\u6a21\u677f",id:"\u914d\u7f6e-alertmanager-\u544a\u8b66\u6a21\u677f",level:4},{value:"\u4e09\u3001\u542f\u52a8\u670d\u52a1",id:"\u4e09\u542f\u52a8\u670d\u52a1",level:2},{value:"\u7f16\u8f91\u96c6\u7fa4\u76d1\u63a7\u7684 docker compose \u914d\u7f6e\u6587\u4ef6",id:"\u7f16\u8f91\u96c6\u7fa4\u76d1\u63a7\u7684-docker-compose-\u914d\u7f6e\u6587\u4ef6",level:3},{value:"\u542f\u52a8\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1\u76f8\u5173\u5bb9\u5668",id:"\u542f\u52a8\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1\u76f8\u5173\u5bb9\u5668",level:3},{value:"\u521d\u59cb\u5316 alert-db",id:"\u521d\u59cb\u5316-alert-db",level:3},{value:"\u7f16\u8f91 <code>/root/monitor/bootstrap.sql</code>",id:"\u7f16\u8f91-rootmonitorbootstrapsql",level:4},{value:"\u7f16\u8f91 <code>/root/monitor/fingerprint.sql</code>",id:"\u7f16\u8f91-rootmonitorfingerprintsql",level:4},{value:"\u521d\u59cb\u5316",id:"\u521d\u59cb\u5316",level:4},{value:"\u91cd\u542f\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1",id:"\u91cd\u542f\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1",level:3},{value:"\u56db\u3001\u542f\u52a8 exporter \u670d\u52a1",id:"\u56db\u542f\u52a8-exporter-\u670d\u52a1",level:2},{value:"\u5b89\u88c5 golang",id:"\u5b89\u88c5-golang",level:3},{value:"\u7f16\u8bd1\u5b89\u88c5 exporter",id:"\u7f16\u8bd1\u5b89\u88c5-exporter",level:3},{value:"\u4e94\u3001OpenSCOW \u914d\u7f6e\u5f00\u542f\u96c6\u7fa4\u76d1\u63a7\u529f\u80fd",id:"\u4e94openscow-\u914d\u7f6e\u5f00\u542f\u96c6\u7fa4\u76d1\u63a7\u529f\u80fd",level:2}];function c(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"\u90e8\u7f72\u96c6\u7fa4\u76d1\u63a7",children:"\u90e8\u7f72\u96c6\u7fa4\u76d1\u63a7"}),"\n",(0,r.jsx)(n.p,{children:"\u914d\u7f6e\u8be5\u529f\u80fd\u53ef\u4ee5\u8ba9\u7ba1\u7406\u5458\u5728\u7ba1\u7406\u7cfb\u7edf\u4e2d\u67e5\u770b\u96c6\u7fa4\u8d44\u6e90\u4fe1\u606f\u548c\u544a\u8b66\u65e5\u5fd7\uff0c\u9700\u8981\u914d\u7f6e Prometheus\u3001Grafana\u3001Alertmanager\u3001alertsnitch\u3001MySQL \u5b89\u88c5"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u96c6\u7fa4\u8d44\u6e90\u4fe1\u606f"}),"\n",(0,r.jsx)(n.img,{alt:"\u96c6\u7fa4\u8d44\u6e90\u4fe1\u606f",src:t(93500).A+"",width:"1896",height:"905"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u544a\u8b66\u65e5\u5fd7"}),"\n",(0,r.jsx)(n.img,{alt:"\u544a\u8b66\u65e5\u5fd7",src:t(21985).A+"",width:"1902",height:"910"})]}),"\n",(0,r.jsx)(n.h2,{id:"\u4e00\u73af\u5883\u51c6\u5907",children:"\u4e00\u3001\u73af\u5883\u51c6\u5907"}),"\n",(0,r.jsx)(n.p,{children:"\u672c\u76d1\u63a7\u65b9\u6848\u901a\u8fc7 docker-compose \u5b89\u88c5\uff0c\u9700\u8981\u5b89\u88c5 docker \u548c docker-compose\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u5b89\u88c5 docker"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u5b89\u88c5\u6240\u9700\u7684\u5305\nyum install -y yum-utils \\\n  device-mapper-persistent-data \\\n  lvm2\n  \n# \u8bbe\u7f6e\u7a33\u5b9a\u5b58\u50a8\u5e93\nyum-config-manager \\\n    --add-repo \\\n    https://download.docker.com/linux/centos/docker-ce.repo\n    \n**# **\u5b89\u88c5Docker CE**\n**yum install docker-ce -y\n\n# \u5b89\u88c5\u6307\u5b9a\u7248\u672cDocker CE\nyum list docker-ce --showduplicates | sort -r\nyum install docker-ce-23.0.6 -y\n\n**# **\u542f\u52a8Docker CE\u5e76\u8bbe\u7f6e\u5f00\u673a\u542f\u52a8\nsystemctl start docker\nsystemctl enable docker\n\n**# **\u9a8c\u8bc1Docker\u73af\u5883**\n**docker run hello-world\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"\u5b89\u88c5 docker-compose"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'**# **\u4e0b\u8f7d\u5b89\u88c5**\n**curl -L "https://github.com/docker/compose/releases/download/v2.7.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose\nmv docker-compose-linux-x86_64 /usr/local/bin/docker-compose\n**# **\u8d4b\u6743**\n**chmod +x /usr/local/bin/docker-compose\n\n**# **\u9a8c\u8bc1\u5b89\u88c5\u6210\u529f**\n**docker-compose --version\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"\u521b\u5efa\u6301\u4e45\u5316\u914d\u7f6e\u76ee\u5f55"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u521b\u5efa\u5b58\u653e\u914d\u7f6e\u7684\u76ee\u5f55\nmkdir -p /root/monitor\nmkdir -p /root/monitor/alertmanager\nmkdir -p /root/monitor/alertmanager/template\nmkdir -p /root/monitor/grafana\nmkdir -p /root/monitor/grafana/provisioning\nmkdir -p /root/monitor/grafana/provisioning/dashboards\nmkdir -p /root/monitor/grafana/provisioning/dashboards/tmp\nmkdir -p /root/monitor/grafana/provisioning/datasources\nmkdir -p /root/monitor/prometheus\nmkdir -p /root/monitor/prometheus/rules\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e8c\u521b\u5efa\u914d\u7f6e\u6587\u4ef6",children:"\u4e8c\u3001\u521b\u5efa\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsx)(n.p,{children:"\u6ce8\u610f\uff1a\u914d\u7f6e\u6587\u4ef6\u4e2d\u5404\u4e3b\u673a\u540d\u3001\u4e3b\u673a IP \u4ee5\u53ca\u96c6\u7fa4\u4fe1\u606f\u6309\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u4fee\u6539\uff01"})}),"\n",(0,r.jsx)(n.h3,{id:"\u914d\u7f6e-grafana",children:"\u914d\u7f6e Grafana"}),"\n",(0,r.jsxs)(n.h4,{id:"\u7f16\u8f91-grafana-\u914d\u7f6e\u6587\u4ef6rootmonitorgrafanagrafanaini",children:["\u7f16\u8f91 grafana \u914d\u7f6e\u6587\u4ef6\uff1a",(0,r.jsx)(n.code,{children:"/root/monitor/grafana/grafana.ini"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u6b64\u5904\u9700\u8981\u4fee\u6539 [server] \u4e0b\u7684 root_url\uff0c\u5c06 ",(0,r.jsx)(n.code,{children:"your_scow_mis_path"})," \u4fee\u6539\u4e3a OpenSCOW \u7ba1\u7406\u7cfb\u7edf\u7684\u8def\u5f84"]}),"\n",(0,r.jsx)(n.p,{children:"\u6b64\u5904\u914d\u7f6e\u4e86 root_url \u548c allow_embedding\uff0c\u5c06\u5141\u8bb8 grafana \u901a\u8fc7 iframe \u88ab\u5d4c\u5165\u3002\u5e76\u901a\u8fc7 OpenSCOW \u4ee3\u7406\uff0c\u5c06\u8bf7\u6c42\u8f6c\u53d1\u5230 grafana\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"[paths]\n# Path to where grafana can store temp files, sessions, and the sqlite3 db (if that is used)\ndata = /var/lib/grafana\n# folder that contains provisioning config files that grafana will apply on startup and while running.\nprovisioning = /etc/grafana/provisioning\n[auth.anonymous]     \n# enable anonymous access\nenabled = true\n# specify role for unauthenticated users\norg_role = Viewer\n[server]\n# Root URL for specifying the Grafana instance\n# for example\n# root_url=http://localhost:5003/api/admin/monitor/getResourceStatus\nroot_url=[your_scow_mis_path]/api/admin/monitor/getResourceStatus\n[security]\n# Allows embedding Grafana dashboards into iframes in other websites\nallow_embedding = true\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u7f16\u8f91-grafana-\u9ed8\u8ba4\u6570\u636e\u6e90",children:"\u7f16\u8f91 grafana \u9ed8\u8ba4\u6570\u636e\u6e90"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/grafana/provisioning/datasources/prometheus.yaml"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"apiVersion: 1\ndatasources:\n  - name: Prometheus\n    type: prometheus\n    orgId: 1\n    access: proxy\n    url: http://prometheus:9090\n    editable: true\n    isDefault: true\n    jsonData:\n      timeInterval: 5s\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u7f16\u8f91-grafana-mysql-\u6570\u636e\u6e90",children:"\u7f16\u8f91 grafana Mysql \u6570\u636e\u6e90"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/grafana/provisioning/datasources/mysql.yaml"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"apiVersion: 1\n\ndatasources:\n  - name: AlarmDB-MySQL\n    type: mysql\n    url: alert-db:3306\n    user: alertsnitch\n    jsonData:\n      database: alertsnitch\n      maxOpenConns: 100 # Grafana v5.4+\n      maxIdleConns: 100 # Grafana v5.4+\n      maxIdleConnsAuto: true # Grafana v9.5.1+\n      connMaxLifetime: 14400 # Grafana v5.4+\n    secureJsonData:\n      password: alertsnitch\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u7f16\u8f91-grafana-\u9762\u677f\u914d\u7f6e",children:"\u7f16\u8f91 grafana \u9762\u677f\u914d\u7f6e"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/grafana/provisioning/dashboards/dashboard.yaml"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"apiVersion: 1\nproviders:\n  - name: 'default'\n    orgId: 1\n    folder: ''\n    type: file\n    disableDeletion: false\n    updateIntervalSeconds: 10 #how often Grafana will scan for changed dashboards\n    options:\n      path: /etc/grafana/provisioning/dashboards/tmp\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u7f16\u8f91-grafana-\u9762\u677f\u6a21\u677f\u6587\u4ef6",children:"\u7f16\u8f91 grafana \u9762\u677f\u6a21\u677f\u6587\u4ef6"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/grafana/provisioning/dashboards/tmp/JobScheduler.json"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "annotations": {\n    "list": [\n      {\n        "builtIn": 1,\n        "datasource": {\n          "type": "datasource",\n          "uid": "grafana"\n        },\n        "enable": true,\n        "hide": true,\n        "iconColor": "rgba(0, 211, 255, 1)",\n        "name": "Annotations & Alerts",\n        "type": "dashboard"\n      }\n    ]\n  },\n  "editable": true,\n  "fiscalYearStartMonth": 0,\n  "graphTooltip": 0,\n  "links": [],\n  "liveNow": false,\n  "panels": [\n    {\n      "collapsed": false,\n      "datasource": {\n        "type": "prometheus"\n      },\n      "gridPos": {\n        "h": 1,\n        "w": 24,\n        "x": 0,\n        "y": 0\n      },\n      "id": 2,\n      "panels": [],\n      "targets": [\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "refId": "A"\n        }\n      ],\n      "title": "CPU Cores",\n      "type": "row"\n    },\n    {\n      "datasource": {\n        "type": "prometheus"\n      },\n      "fieldConfig": {\n        "defaults": {\n          "color": {\n            "mode": "palette-classic"\n          },\n          "custom": {\n            "axisBorderShow": false,\n            "axisCenteredZero": false,\n            "axisColorMode": "text",\n            "axisLabel": "",\n            "axisPlacement": "auto",\n            "barAlignment": 0,\n            "drawStyle": "line",\n            "fillOpacity": 10,\n            "gradientMode": "none",\n            "hideFrom": {\n              "legend": false,\n              "tooltip": false,\n              "viz": false\n            },\n            "insertNulls": false,\n            "lineInterpolation": "linear",\n            "lineWidth": 1,\n            "pointSize": 5,\n            "scaleDistribution": {\n              "type": "linear"\n            },\n            "showPoints": "never",\n            "spanNulls": false,\n            "stacking": {\n              "group": "A",\n              "mode": "none"\n            },\n            "thresholdsStyle": {\n              "mode": "off"\n            }\n          },\n          "mappings": [],\n          "thresholds": {\n            "mode": "absolute",\n            "steps": [\n              {\n                "color": "green",\n                "value": null\n              },\n              {\n                "color": "red",\n                "value": 80\n              }\n            ]\n          },\n          "unit": "short"\n        },\n        "overrides": []\n      },\n      "gridPos": {\n        "h": 9,\n        "w": 8,\n        "x": 0,\n        "y": 1\n      },\n      "id": 4,\n      "options": {\n        "legend": {\n          "calcs": [\n            "mean",\n            "lastNotNull",\n            "max",\n            "min"\n          ],\n          "displayMode": "table",\n          "placement": "bottom",\n          "showLegend": true\n        },\n        "tooltip": {\n          "mode": "multi",\n          "sort": "none"\n        }\n      },\n      "pluginVersion": "10.2.2",\n      "repeat": "partition",\n      "targets": [\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "editorMode": "code",\n          "expr": "slurm_partition_cpus_idle{clustername=\\"$cluster\\", partition=\\"$partition\\"}",\n          "interval": "",\n          "legendFormat": "available",\n          "range": true,\n          "refId": "A"\n        },\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "editorMode": "code",\n          "expr": "slurm_partition_cpus_allocated{clustername=\\"$cluster\\", partition=\\"$partition\\"}",\n          "interval": "",\n          "legendFormat": "allocated",\n          "range": true,\n          "refId": "B"\n        },\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "editorMode": "code",\n          "expr": "slurm_partition_cpus_other{clustername=\\"$cluster\\", partition=\\"$partition\\"}",\n          "interval": "",\n          "legendFormat": "unavailable",\n          "range": true,\n          "refId": "C"\n        }\n      ],\n      "title": "${partition}",\n      "type": "timeseries"\n    },\n    {\n      "collapsed": true,\n      "datasource": {\n        "type": "prometheus"\n      },\n      "gridPos": {\n        "h": 1,\n        "w": 24,\n        "x": 0,\n        "y": 10\n      },\n      "id": 8,\n      "panels": [],\n      "targets": [\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "refId": "A"\n        }\n      ],\n      "title": "Job Count",\n      "type": "row"\n    },\n    {\n      "datasource": {\n        "type": "prometheus"\n      },\n      "fieldConfig": {\n        "defaults": {\n          "color": {\n            "mode": "palette-classic"\n          },\n          "custom": {\n            "axisBorderShow": false,\n            "axisCenteredZero": false,\n            "axisColorMode": "text",\n            "axisLabel": "",\n            "axisPlacement": "auto",\n            "barAlignment": 0,\n            "drawStyle": "line",\n            "fillOpacity": 10,\n            "gradientMode": "none",\n            "hideFrom": {\n              "legend": false,\n              "tooltip": false,\n              "viz": false\n            },\n            "insertNulls": false,\n            "lineInterpolation": "linear",\n            "lineWidth": 1,\n            "pointSize": 5,\n            "scaleDistribution": {\n              "type": "linear"\n            },\n            "showPoints": "never",\n            "spanNulls": false,\n            "stacking": {\n              "group": "A",\n              "mode": "none"\n            },\n            "thresholdsStyle": {\n              "mode": "off"\n            }\n          },\n          "mappings": [],\n          "thresholds": {\n            "mode": "absolute",\n            "steps": [\n              {\n                "color": "green",\n                "value": null\n              },\n              {\n                "color": "red",\n                "value": 80\n              }\n            ]\n          },\n          "unit": "short"\n        },\n        "overrides": []\n      },\n      "gridPos": {\n        "h": 12,\n        "w": 8,\n        "x": 0,\n        "y": 11\n      },\n      "id": 12,\n      "options": {\n        "legend": {\n          "calcs": [\n            "mean",\n            "lastNotNull",\n            "max",\n            "min"\n          ],\n          "displayMode": "table",\n          "placement": "bottom",\n          "showLegend": true\n        },\n        "tooltip": {\n          "mode": "multi",\n          "sort": "none"\n        }\n      },\n      "pluginVersion": "10.2.2",\n      "repeat": "partition",\n      "targets": [\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "editorMode": "code",\n          "expr": "slurm_partition_jobs_running{clustername=\\"$cluster\\", partition=\\"$partition\\"}",\n          "interval": "",\n          "legendFormat": "RUNNING",\n          "range": true,\n          "refId": "A"\n        },\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "editorMode": "code",\n          "expr": "slurm_partition_jobs_pending{clustername=\\"$cluster\\", partition=\\"$partition\\"}",\n          "interval": "",\n          "legendFormat": "PENDING",\n          "range": true,\n          "refId": "B"\n        },\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "editorMode": "code",\n          "expr": "slurm_partition_jobs_suspended{clustername=\\"$cluster\\", partition=\\"$partition\\"}",\n          "interval": "",\n          "legendFormat": "SUSPENDED",\n          "range": true,\n          "refId": "C"\n        },\n        {\n          "datasource": {\n            "type": "prometheus"\n          },\n          "editorMode": "code",\n          "expr": "slurm_partition_jobs_completing{clustername=\\"$cluster\\", partition=\\"$partition\\"}",\n          "interval": "",\n          "legendFormat": "COMPLETING",\n          "range": true,\n          "refId": "D"\n        }\n      ],\n      "title": "$partition",\n      "type": "timeseries"\n    }\n  ],\n  "refresh": "",\n  "schemaVersion": 38,\n  "tags": [],\n  "templating": {\n    "list": [\n      {\n        "current": {\n          "selected": false,\n          "text": "hpc01",\n          "value": "hpc01"\n        },\n        "datasource": {\n          "type": "prometheus"\n        },\n        "definition": "label_values(clustername)",\n        "hide": 0,\n        "includeAll": false,\n        "label": "\u96c6\u7fa4",\n        "multi": false,\n        "name": "cluster",\n        "options": [],\n        "query": "label_values(clustername)",\n        "refresh": 2,\n        "regex": "",\n        "skipUrlSync": false,\n        "sort": 0,\n        "tagValuesQuery": "",\n        "tagsQuery": "",\n        "type": "query",\n        "useTags": false\n      },\n      {\n        "current": {\n          "selected": true,\n          "text": [\n            "All"\n          ],\n          "value": [\n            "$__all"\n          ]\n        },\n        "datasource": {\n          "type": "prometheus"\n        },\n        "definition": "label_values(slurm_partition_cpus_total{clustername=\\"$cluster\\"}, partition)",\n        "hide": 0,\n        "includeAll": true,\n        "label": "\u5206\u533a",\n        "multi": true,\n        "name": "partition",\n        "options": [],\n        "query": "label_values(slurm_partition_cpus_total{clustername=\\"$cluster\\"}, partition)",\n        "refresh": 2,\n        "regex": "",\n        "skipUrlSync": false,\n        "sort": 0,\n        "tagValuesQuery": "",\n        "tagsQuery": "",\n        "type": "query",\n        "useTags": false\n      }\n    ]\n  },\n  "time": {\n    "from": "now-24h",\n    "to": "now"\n  },\n  "timepicker": {\n    "refresh_intervals": [\n      "10s",\n      "30s",\n      "1m",\n      "5m",\n      "15m",\n      "30m",\n      "1h",\n      "2h",\n      "1d"\n    ]\n  },\n  "timezone": "",\n  "title": "Job Scheduler",\n  "uid": "shZOtO4Sk",\n  "version": 1,\n  "weekStart": ""\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u914d\u7f6e-prometheus",children:"\u914d\u7f6e Prometheus"}),"\n",(0,r.jsx)(n.h4,{id:"\u914d\u7f6e-prometheus-\u914d\u7f6e\u6587\u4ef6",children:"\u914d\u7f6e Prometheus \u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/prometheus/prometheus.yml"})}),"\n",(0,r.jsx)(n.p,{children:"\u6ce8\u610f\uff1ascrape_configs \u4e0b slurm_exporter \u4e2d slurmctlIP \u9700\u8981\u66ff\u6362\u6210 slurm \u7ba1\u7406\u8282\u70b9\u5b9e\u9645\u7684 IP \u5730\u5740"}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u6709\u591a\u4e2a slurm \u7ba1\u7406\u8282\u70b9\u5219\u5728 ",(0,r.jsx)(n.code,{children:"scrape_configs"})," \u4e0b slurm_exporter \u4e2d\u7684 ",(0,r.jsx)(n.code,{children:"static_configs"})," \u91cc\u9762\u914d\u7f6e\u66f4\u591a\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"global:\n  scrape_interval:   60s # Set the scrape interval to every 15 seconds. Default is every 1 minute.\n  evaluation_interval: 60s # Evaluate rules every 15 seconds. The default is every 1 minute.\n\n# Alertmanager configuration\nalerting:\n  alertmanagers:\n  - static_configs:\n    - targets: [\"alertmanager:9093\"]\n\n# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.\nrule_files:\n  - \"rules/rules.yml\"\n\nscrape_configs:\n  - job_name: 'slurm_exporter'\n    scrape_interval:  30s\n    scrape_timeout:   30s\n    static_configs:\n      - targets: ['[slurmctlIP]:9341']\n        labels:\n          appname: 'hpc01' #\u6dfb\u52a0\u7684\u6807\u7b7e\n          clustername: 'hpc01' #\u6dfb\u52a0\u7684\u6807\u7b7e\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: [ 'prometheus:9090']\n        labels:\n          appname: 'prometheus'\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u914d\u7f6e-prometheus-\u544a\u8b66\u89c4\u5219",children:"\u914d\u7f6e Prometheus \u544a\u8b66\u89c4\u5219"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/prometheus/rules/rules.yml"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# slurmAlert\ngroups:\n- name: slurmAlert\n  rules:\n  - alert: SlurmPartitionCPUUsage\n    expr: (slurm_partition_cpus_total - slurm_partition_cpus_idle)/slurm_partition_cpus_total > 0.80\n    for: 1m\n    labels:\n      severity: "Warning"\n    annotations:\n      summary: "SLURM partition CPU usgae high"\n      description: "{{ $labels.clustername }} partition: {{ $labels.partition }} - CPU usage above 80% (current value: {{ $value }})"\n  - alert: SlurmPendingJob\n    expr: slurm_partition_jobs_pending >= 5\n    for: 1m\n    labels:\n      severity: "Warning"\n    annotations:\n      summary: "Too many jobs queued"\n      description: "{{ $labels.clustername }} partition: {{ $labels.partition }} - Too many jobs queued (current value: {{ $value }})"\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u914d\u7f6e-alertmanager",children:"\u914d\u7f6e Alertmanager"}),"\n",(0,r.jsx)(n.h4,{id:"\u914d\u7f6e-alertmanager-\u914d\u7f6e\u6587\u4ef6",children:"\u914d\u7f6e Alertmanager \u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/alertmanager/alertmanager.yml"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"global:\n  smtp_smarthost: 'smtp.163.com:25'\n  smtp_from: 'xxxxxxx@163.com'\n  smtp_auth_username: 'xxxxxxx@163.com'\n  smtp_auth_password: 'XXXXXXXXXXXXXXXX'\n  smtp_require_tls: false\n\ntemplates:\n  - '/etc/alertmanager/template/*.tmpl'\n\nroute:\n  group_by: ['alertname','cluster','service']\n  group_wait: 30s\n  group_interval: 10s\n  repeat_interval: 10m\n  receiver: 'default-receiver'\n  routes:\n  - receiver: 'alertsnitch'\n    continue: true\n\nreceivers:\n  - name: 'default-receiver'\n    email_configs:\n    - to: 'xxxxxxx@qq.com'\n      html: '{{ template \"email.default.html\" . }}'\n      headers: { Subject: \"Prometheus \u544a\u8b66\u6d4b\u8bd5\u90ae\u4ef6\" }\n  - name: 'alertsnitch'\n    webhook_configs:\n    - send_resolved: true\n      http_config:\n        follow_redirects: true\n      url: http://alertsnitch:9567/webhook\n"})}),"\n",(0,r.jsx)(n.h4,{id:"\u914d\u7f6e-alertmanager-\u544a\u8b66\u6a21\u677f",children:"\u914d\u7f6e Alertmanager \u544a\u8b66\u6a21\u677f"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/alertmanager/template/default.tmpl"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'{{ define "__alertmanager" }}Alertmanager{{ end }}\n{{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver | urlquery }}{{ end }}\n\n{{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}\n{{ define "__description" }}{{ end }}\n\n{{ define "__text_alert_list" }}{{ range . }}Labels:\n{{ range .Labels.SortedPairs }} - {{ .Name }} = {{ .Value }}\n{{ end }}Annotations:\n{{ range .Annotations.SortedPairs }} - {{ .Name }} = {{ .Value }}\n{{ end }}Source: {{ .GeneratorURL }}\n{{ end }}{{ end }}\n\n{{ define "__text_alert_list_markdown" }}{{ range . }}\nLabels:\n{{ range .Labels.SortedPairs }}  - {{ .Name }} = {{ .Value }}\n{{ end }}\nAnnotations:\n{{ range .Annotations.SortedPairs }}  - {{ .Name }} = {{ .Value }}\n{{ end }}\nSource: {{ .GeneratorURL }}\n{{ end }}\n{{ end }}\n\n{{ define "slack.default.title" }}{{ template "__subject" . }}{{ end }}\n{{ define "slack.default.username" }}{{ template "__alertmanager" . }}{{ end }}\n{{ define "slack.default.fallback" }}{{ template "slack.default.title" . }} | {{ template "slack.default.titlelink" . }}{{ end }}\n{{ define "slack.default.callbackid" }}{{ end }}\n{{ define "slack.default.pretext" }}{{ end }}\n{{ define "slack.default.titlelink" }}{{ template "__alertmanagerURL" . }}{{ end }}\n{{ define "slack.default.iconemoji" }}{{ end }}\n{{ define "slack.default.iconurl" }}{{ end }}\n{{ define "slack.default.text" }}{{ end }}\n{{ define "slack.default.footer" }}{{ end }}\n\n\n{{ define "pagerduty.default.description" }}{{ template "__subject" . }}{{ end }}\n{{ define "pagerduty.default.client" }}{{ template "__alertmanager" . }}{{ end }}\n{{ define "pagerduty.default.clientURL" }}{{ template "__alertmanagerURL" . }}{{ end }}\n{{ define "pagerduty.default.instances" }}{{ template "__text_alert_list" . }}{{ end }}\n\n\n{{ define "opsgenie.default.message" }}{{ template "__subject" . }}{{ end }}\n{{ define "opsgenie.default.description" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}\n{{ if gt (len .Alerts.Firing) 0 -}}\nAlerts Firing:\n{{ template "__text_alert_list" .Alerts.Firing }}\n{{- end }}\n{{ if gt (len .Alerts.Resolved) 0 -}}\nAlerts Resolved:\n{{ template "__text_alert_list" .Alerts.Resolved }}\n{{- end }}\n{{- end }}\n{{ define "opsgenie.default.source" }}{{ template "__alertmanagerURL" . }}{{ end }}\n\n\n{{ define "wechat.default.message" }}{{ template "__subject" . }}\n{{ .CommonAnnotations.SortedPairs.Values | join " " }}\n{{ if gt (len .Alerts.Firing) 0 -}}\nAlerts Firing:\n{{ template "__text_alert_list" .Alerts.Firing }}\n{{- end }}\n{{ if gt (len .Alerts.Resolved) 0 -}}\nAlerts Resolved:\n{{ template "__text_alert_list" .Alerts.Resolved }}\n{{- end }} \nAlertmanagerUrl:\n{{ template "__alertmanagerURL" . }}\n{{- end }}\n{{ define "wechat.default.to_user" }}{{ end }}\n{{ define "wechat.default.to_party" }}{{ end }}\n{{ define "wechat.default.to_tag" }}{{ end }}\n{{ define "wechat.default.agent_id" }}{{ end }}\n\n\n\n{{ define "victorops.default.state_message" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}\n{{ if gt (len .Alerts.Firing) 0 -}} \nAlerts Firing:\n{{ template "__text_alert_list" .Alerts.Firing }}\n{{- end }}\n{{ if gt (len .Alerts.Resolved) 0 -}}\nAlerts Resolved:\n{{ template "__text_alert_list" .Alerts.Resolved }}\n{{- end }}\n{{- end }}\n{{ define "victorops.default.entity_display_name" }}{{ template "__subject" . }}{{ end }}\n{{ define "victorops.default.monitoring_tool" }}{{ template "__alertmanager" . }}{{ end }}\n\n{{ define "pushover.default.title" }}{{ template "__subject" . }}{{ end }}\n{{ define "pushover.default.message" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}\n{{ if gt (len .Alerts.Firing) 0 }}\nAlerts Firing:\n{{ template "__text_alert_list" .Alerts.Firing }}\n{{ end }}\n{{ if gt (len .Alerts.Resolved) 0 }}\nAlerts Resolved:\n{{ template "__text_alert_list" .Alerts.Resolved }}\n{{ end }} \n{{ end }}\n{{ define "pushover.default.url" }}{{ template "__alertmanagerURL" . }}{{ end }}\n\n{{ define "sns.default.subject" }}{{ template "__subject" . }}{{ end }}\n{{ define "sns.default.message" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}\n{{ if gt (len .Alerts.Firing) 0 }}\nAlerts Firing:\n{{ template "__text_alert_list" .Alerts.Firing }}\n{{ end }}\n{{ if gt (len .Alerts.Resolved) 0 }}\nAlerts Resolved:\n{{ template "__text_alert_list" .Alerts.Resolved }}\n{{ end }}\n{{ end }}\n\n{{ define "telegram.default.message" }} \n{{ if gt (len .Alerts.Firing) 0 }}\nAlerts Firing:\n{{ template "__text_alert_list" .Alerts.Firing }}\n{{ end }}\n{{ if gt (len .Alerts.Resolved) 0 }}\nAlerts Resolved:\n{{ template "__text_alert_list" .Alerts.Resolved }}\n{{ end }}\n{{ end }}\n\n{{ define "discord.default.title" }}{{ template "__subject" . }}{{ end }}\n{{ define "discord.default.message" }}\n{{ if gt (len .Alerts.Firing) 0 }}\nAlerts Firing:\n{{ template "__text_alert_list" .Alerts.Firing }}\n{{ end }}\n{{ if gt (len .Alerts.Resolved) 0 }}\nAlerts Resolved:\n{{ template "__text_alert_list" .Alerts.Resolved }}\n{{ end }} \n{{ end }} \n\n{{ define "webex.default.message" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}\n{{ if gt (len .Alerts.Firing) 0 }}\nAlerts Firing:\n{{ template "__text_alert_list" .Alerts.Firing }}\n{{ end }}\n{{ if gt (len .Alerts.Resolved) 0 }}\nAlerts Resolved:\n{{ template "__text_alert_list" .Alerts.Resolved }}\n{{ end }} \n{{ end }}\n\n{{ define "msteams.default.title" }}{{ template "__subject" . }}{{ end }}\n{{ define "msteams.default.text" }}\n{{ if gt (len .Alerts.Firing) 0 }}\n# Alerts Firing:\n{{ template "__text_alert_list_markdown" .Alerts.Firing }}\n{{ end }}\n{{ if gt (len .Alerts.Resolved) 0 }}\n# Alerts Resolved:\n{{ template "__text_alert_list_markdown" .Alerts.Resolved }}\n{{ end }}\n{{ end }}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e09\u542f\u52a8\u670d\u52a1",children:"\u4e09\u3001\u542f\u52a8\u670d\u52a1"}),"\n",(0,r.jsx)(n.h3,{id:"\u7f16\u8f91\u96c6\u7fa4\u76d1\u63a7\u7684-docker-compose-\u914d\u7f6e\u6587\u4ef6",children:"\u7f16\u8f91\u96c6\u7fa4\u76d1\u63a7\u7684 docker compose \u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"/root/monitor/monitor.yaml"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u9700\u8981\u4fee\u6539 ",(0,r.jsx)(n.code,{children:"alert-db"})," \u5bc6\u7801\uff0c\u5219\u5728\u5bf9\u5e94\u5bb9\u5668\u914d\u7f6e\u4e0b\u4fee\u6539\u5373\u53ef\u3002\u5982\u679c\u4fee\u6539 mysql \u7528\u6237 ",(0,r.jsx)(n.code,{children:"alertsnitch"})," \u7684\u5bc6\u7801\uff0c\u9700\u8981\u5728\u914d\u7f6e grafana \u7684 mysql \u6570\u636e\u6e90\u5904\u540c\u6b65\u4fee\u6539\u5bc6\u7801"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'version: "3.1"\nservices:\n  grafana:\n    container_name: grafana\n    image: grafana/grafana:10.2.2\n    user: root\n    ports:\n      - "4000:3000"\n    volumes:\n      - /root/monitor/grafana:/etc/grafana\n      - grafana_data:/var/lib/grafana\n    restart: unless-stopped\n  prometheus:\n    container_name: prometheus\n    image: prom/prometheus\n    user: root\n    ports:\n      - "9090:9090"\n    volumes:\n      - /root/monitor/prometheus:/etc/prometheus\n      - prometheus_data:/prometheus\n    restart: unless-stopped\n  alertmanager:\n    container_name: alertmanager\n    image: prom/alertmanager\n    user: root\n    ports:\n      - 9093:9093\n    volumes:\n      - /root/monitor/alertmanager:/etc/alertmanager\n      - alertmanager_data:/alertmanager\n    command:\n      - "--config.file=/etc/alertmanager/alertmanager.yml"\n      - "--storage.path=/alertmanager"\n    restart: unless-stopped\n  alert-db:\n    container_name: alert-db\n    image: mysql:5.7\n    command: --default-authentication-plugin=mysql_native_password\n    environment:\n      MYSQL_DATABASE: alertsnitch\n      MYSQL_USER: "alertsnitch"\n      MYSQL_PASSWORD: "alertsnitch"\n      MYSQL_ROOT_PASSWORD: "root"\n    volumes:\n      - alert_db_data:/var/lib/mysql\n    restart: unless-stopped\n  alertsnitch:\n    container_name: alertsnitch\n    image: registry.gitlab.com/yakshaving.art/alertsnitch\n    ports:\n      - 9567:9567\n    environment:\n      ALERTSNITCH_BACKEND: "mysql"\n      ALERTSNITCH_DSN: "alertsnitch:alertsnitch@tcp(alert-db)/alertsnitch"\n    restart: unless-stopped\n    depends_on:\n      - alert-db\nvolumes:\n  prometheus_data: {}\n  grafana_data: {}\n  alertmanager_data: {}\n  alert_db_data: {}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u542f\u52a8\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1\u76f8\u5173\u5bb9\u5668",children:"\u542f\u52a8\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1\u76f8\u5173\u5bb9\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u542f\u52a8\u540e alertsnitch \u5bb9\u5668\u4f1a\u4e0d\u65ad\u91cd\u542f\uff0c\u9700\u8981\u5b8c\u6210\u521d\u59cb\u5316 alert-db \u6b65\u9aa4\u540e\u518d\u91cd\u542f\u6574\u4e2a\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd /root/monitor\ndocker-compose -f monitor.yaml up -d\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u521d\u59cb\u5316-alert-db",children:"\u521d\u59cb\u5316 alert-db"}),"\n",(0,r.jsxs)(n.h4,{id:"\u7f16\u8f91-rootmonitorbootstrapsql",children:["\u7f16\u8f91 ",(0,r.jsx)(n.code,{children:"/root/monitor/bootstrap.sql"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"DROP PROCEDURE IF EXISTS bootstrap;\n\nDELIMITER //\nCREATE PROCEDURE bootstrap()\nBEGIN\n  SET @exists := (SELECT 1 FROM information_schema.tables I WHERE I.table_name = \"Model\" AND I.table_schema = database());\n  IF @exists IS NULL THEN\n\n    CREATE TABLE `Model` (\n      `ID` enum('1') NOT NULL,\n      `version` VARCHAR(20) NOT NULL,\n      PRIMARY KEY (`ID`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\n    INSERT INTO `Model` (`version`) VALUES (\"0.0.1\");\n\n  ELSE\n    SIGNAL SQLSTATE '42000' SET MESSAGE_TEXT='Model Table Exists, quitting...';\n  END IF;\nEND;\n//\nDELIMITER ;\n\n-- Execute the procedure\nCALL bootstrap();\n\n-- Drop the procedure\nDROP PROCEDURE bootstrap;\n\n-- Create the rest of the tables\nCREATE TABLE `AlertGroup` (\n        `ID` INT NOT NULL AUTO_INCREMENT,\n        `time` TIMESTAMP NOT NULL,\n        `receiver` VARCHAR(100) NOT NULL,\n        `status` VARCHAR(50) NOT NULL,\n        `externalURL` TEXT NOT NULL,\n        `groupKey` VARCHAR(255) NOT NULL,\n        KEY `idx_time` (`time`) USING BTREE,\n    KEY `idx_status_ts` (`status`, `time`) USING BTREE,\n        PRIMARY KEY (`ID`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nCREATE TABLE `GroupLabel` (\n        `ID` INT NOT NULL AUTO_INCREMENT,\n    `AlertGroupID` INT NOT NULL,\n    `GroupLabel` VARCHAR(100) NOT NULL,\n    `Value` VARCHAR(1000) NOT NULL,\n    FOREIGN KEY (AlertGroupID) REFERENCES AlertGroup (ID) ON DELETE CASCADE,\n        PRIMARY KEY (`ID`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nCREATE TABLE `CommonLabel` (\n        `ID` INT NOT NULL AUTO_INCREMENT,\n    `AlertGroupID` INT NOT NULL,\n    `Label` VARCHAR(100) NOT NULL,\n    `Value` VARCHAR(1000) NOT NULL,\n    FOREIGN KEY (AlertGroupID) REFERENCES AlertGroup (ID) ON DELETE CASCADE,\n        PRIMARY KEY (`ID`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nCREATE TABLE `CommonAnnotation` (\n        `ID` INT NOT NULL AUTO_INCREMENT,\n    `AlertGroupID` INT NOT NULL,\n    `Annotation` VARCHAR(100) NOT NULL,\n    `Value` VARCHAR(1000) NOT NULL,\n    FOREIGN KEY (AlertGroupID) REFERENCES AlertGroup (ID) ON DELETE CASCADE,\n        PRIMARY KEY (`ID`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nCREATE TABLE `Alert` (\n        `ID` INT NOT NULL AUTO_INCREMENT,\n    `alertGroupID` INT NOT NULL,\n        `status` VARCHAR(50) NOT NULL,\n    `startsAt` DATETIME NOT NULL,\n    `endsAt` DATETIME DEFAULT NULL,\n        `generatorURL` TEXT NOT NULL,\n    FOREIGN KEY (alertGroupID) REFERENCES AlertGroup (ID) ON DELETE CASCADE,\n        PRIMARY KEY (`ID`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nCREATE TABLE `AlertLabel` (\n        `ID` INT NOT NULL AUTO_INCREMENT,\n    `AlertID` INT NOT NULL,\n    `Label` VARCHAR(100) NOT NULL,\n    `Value` VARCHAR(1000) NOT NULL,\n    FOREIGN KEY (AlertID) REFERENCES Alert (ID) ON DELETE CASCADE,\n        PRIMARY KEY (`ID`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\nCREATE TABLE `AlertAnnotation` (\n        `ID` INT NOT NULL AUTO_INCREMENT,\n    `AlertID` INT NOT NULL,\n    `Annotation` VARCHAR(100) NOT NULL,\n    `Value` VARCHAR(1000) NOT NULL,\n    FOREIGN KEY (AlertID) REFERENCES Alert (ID) ON DELETE CASCADE,\n        PRIMARY KEY (`ID`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"\u7f16\u8f91-rootmonitorfingerprintsql",children:["\u7f16\u8f91 ",(0,r.jsx)(n.code,{children:"/root/monitor/fingerprint.sql"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'# db.d/mysql/0.1.0-fingerprint.sql\nALTER TABLE Alert\n    ADD `fingerprint` TEXT NOT NULL;\n\nUPDATE `Model`  SET `version`="0.1.0";\n'})}),"\n",(0,r.jsx)(n.h4,{id:"\u521d\u59cb\u5316",children:"\u521d\u59cb\u5316"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u5c06\u4e0a\u4e24\u6b65\u7684 sql \u6587\u4ef6\u5206\u522b\u62f7\u8d1d\u5230 alert-db \u5bb9\u5668\n# container_id \u901a\u8fc7\u67e5\u8be2 alert-db \u5bb9\u5668 id \u83b7\u53d6\ndocker cp /root/monitor/bootstrap.sql container_id:/root\ndocker cp /root/monitor/fingerprint.sql container_id:/root\n\n# \u8fdb\u5165\u5bb9\u5668\ndocker exec -it container_id /bin/sh\n\n# \u8fdb\u5165\u5bb9\u5668\u540e\ncd /root\n# \u4f7f\u7528root\u767b\u5f55\u6570\u636e\u5e93\uff0c\u5bc6\u7801\u662froot\nmysql -uroot -p\n\n\u5207\u5230alertsnitch\u6570\u636e\u5e93\nuse alertsnitch\n\n\u6267\u884csql\u6587\u4ef6\nsource bootstrap.sql\nsource fingerprint.sql\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u91cd\u542f\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1",children:"\u91cd\u542f\u96c6\u7fa4\u76d1\u63a7\u670d\u52a1"}),"\n",(0,r.jsx)(n.p,{children:"\u9000\u51fa alert-db \u5bb9\u5668\uff0c\u7136\u540e\u91cd\u542f\u670d\u52a1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"docker-compose -f monitor.yaml restart\n# \u68c0\u67e5\u670d\u52a1\u662f\u5426\u542f\u52a8\u6210\u529f\ndocker ps\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u56db\u542f\u52a8-exporter-\u670d\u52a1",children:"\u56db\u3001\u542f\u52a8 exporter \u670d\u52a1"}),"\n",(0,r.jsx)(n.p,{children:"\u4ee5\u4e0b\u64cd\u4f5c\u5747\u5728 slurm \u7ba1\u7406\u8282\u70b9\u4e0a\u8fdb\u884c"}),"\n",(0,r.jsx)(n.h3,{id:"\u5b89\u88c5-golang",children:"\u5b89\u88c5 golang"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u4e0b\u8f7dgo\u8bed\u8a00\u5b89\u88c5\u5305\uff0c\u5b89\u88c5gocd download/\nwget https://golang.google.cn/dl/go1.19.7.linux-amd64.tar.gz\ntar -C /usr/local -xzf go1.19.7.linux-amd64.tar.gz\n\n# \u5728/etc/profile\u4e2d\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\nexport GOROOT=/usr/local/go\nexport GOPATH=/usr/local/gopath\nexport PATH=$PATH:/$GOROOT/bin:$GOPATH/bin\n\n# source\u73af\u5883\u53d8\u91cf\nsource /etc/profile\n\n# \u9a8c\u8bc1\ngo version\n\n# \u8bbe\u7f6e\u4ee3\u7406\ngo env -w GOPROXY=https://goproxy.cn,direct\n\n# \u5f00\u542fgo mod\u7ba1\u7406\ngo env -w GO111MODULE=on\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u7f16\u8bd1\u5b89\u88c5-exporter",children:"\u7f16\u8bd1\u5b89\u88c5 exporter"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u4e0b\u8f7d\u4ee3\u7801\ngit clone https://github.com/PKUHPC/prometheus-slurm-exporter.git\ncd prometheus-slurm-exporter\n// \u7f16\u8bd1\nmake\n# \u5b89\u88c5\ncp bin/prometheus-slurm-exporter /usr/bin/prometheus-slurm-exporter\ncp lib/systemd/prometheus-slurm-exporter.service /usr/lib/systemd/system\n# \u542f\u52a8exporter\u670d\u52a1\nsystemctl start prometheus-slurm-exporter.service\n# \u67e5\u770b\u670d\u52a1\u72b6\u6001\nsystemctl status prometheus-slurm-exporter.service\n# \u542f\u7528\u5f00\u673a\u542f\u52a8exporter\u670d\u52a1\nsystemctl enable prometheus-slurm-exporter.service\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u4e94openscow-\u914d\u7f6e\u5f00\u542f\u96c6\u7fa4\u76d1\u63a7\u529f\u80fd",children:"\u4e94\u3001OpenSCOW \u914d\u7f6e\u5f00\u542f\u96c6\u7fa4\u76d1\u63a7\u529f\u80fd"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728 ",(0,r.jsx)(n.code,{children:"mis.yaml"})," \u6587\u4ef6\u4e2d\u589e\u52a0\u5982\u4e0b\u914d\u7f6e\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# \u96c6\u7fa4\u76d1\u63a7\u914d\u7f6e\nclusterMonitor:\n  # \u534f\u8bae + ip/\u57df\u540d + \u7aef\u53e3\uff0c\u9ed8\u8ba4\u4e3a http://127.0.0.1:4000\n  grafanaUrl: "[your-grafana-url]"\n  # \u8d44\u6e90\u72b6\u6001\u76f8\u5173\u914d\u7f6e\n  resourceStatus:\n    # \u662f\u5426\u5f00\u542f\u8d44\u6e90\u72b6\u6001\uff0c\u9ed8\u8ba4\u4e0d\u5f00\u542f\n    enabled: true\n    # \u662f\u5426\u4f7f\u7528\u4ee3\u7406\u7684\u65b9\u5f0f\n    proxy: true\n    # \u9ed8\u8ba4\u9762\u677f id,\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a shZOtO4Sk\n    dashboardUid: "shZOtO4Sk"\n  # \u544a\u8b66\u65e5\u5fd7\u914d\u7f6e\n  alarmLogs:\n    # \u662f\u5426\u5f00\u542f\u544a\u8b66\u65e5\u5fd7\uff0c\u9ed8\u8ba4\u4e0d\u5f00\u542f\n    enabled: true\n'})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},21985:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/alarmLog-4de6d965a6fb8d85697f231116ae54c5.png"},93500:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/resourceStatus-08081b8fb398cc77dbba5e390cf42e69.png"},5409:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var r=t(48318);const a={},l=r.createContext(a);function s(e){const n=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);